<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY FRET ‚Äî Connexion Chauffeur</title>
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="Connexion chauffeur DIGIY FRET par PIN s√©curis√©. 0% commission." />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg1:#f7fbff;--bg2:#fff7ed;--line:rgba(0,0,0,.08);--sky:#0ea5e9;--gold:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
      font-family:system-ui,Arial;background:
        radial-gradient(900px 600px at 20% 10%, rgba(56,189,248,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(245,158,11,.18), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg2));padding:18px}
    .card{width:100%;max-width:420px;background:#fff;border:1px solid var(--line);
      border-radius:22px;padding:20px}
    .logo{width:60px;height:60px;border-radius:18px;margin:0 auto 12px;
      background:linear-gradient(135deg,var(--sky),var(--gold));display:grid;place-items:center;font-weight:900;font-size:28px}
    h1{margin:0;text-align:center;font-size:18px}
    p{margin:6px 0 16px;text-align:center;color:#5b6472;font-weight:700}
    label{display:block;font-weight:900;font-size:13px;margin:12px 0 6px}
    input{width:100%;padding:13px;border-radius:14px;border:1px solid var(--line);font-weight:900;font-size:15px}
    button{width:100%;margin-top:14px;padding:13px;border-radius:14px;border:0;
      background:linear-gradient(135deg,var(--sky),var(--gold));font-weight:950;cursor:pointer}
    .msg{margin-top:12px;font-weight:900;text-align:center}
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">üöö</div>
    <h1>DIGIY FRET</h1>
    <p>Connexion Chauffeur ‚Ä¢ PIN s√©curis√©</p>

    <label>üì± Num√©ro</label>
    <input id="phone" placeholder="+221771234567" inputmode="tel" />

    <label>üîê PIN</label>
    <input id="pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" inputmode="numeric" />

    <button id="btn">Connexion</button>
    <div class="msg" id="msg"></div>
  </div>

<script>
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $=id=>document.getElementById(id);
function normalizePhone(p){
  if(!p) return "";
  p = String(p).trim().replace(/[^\d+]/g,"");
  if(/^0\d{8,}$/.test(p)) p = "+221"+p.replace(/^0+/,"");
  if(/^\d{9}$/.test(p)) p = "+221"+p;
  if(/^\d{11,15}$/.test(p) && !p.startsWith("+")) p = "+"+p;
  return p.startsWith("+") ? p : "";
}

$("btn").onclick = async ()=>{
  $("msg").textContent = "";
  const phone = normalizePhone($("phone").value);
  const pin = ($("pin").value||"").trim();
  if(!phone || pin.length < 3){ $("msg").textContent="Num√©ro ou PIN invalide"; return; }

  const { data, error } = await sb.rpc("rpc_driver_login", { p_phone: phone, p_pin: pin });
  if(error){ $("msg").textContent="PIN incorrect ou chauffeur inconnu"; return; }

  localStorage.setItem("digiy_fret_driver_token", data.token);
  localStorage.setItem("digiy_fret_driver_expires", data.expires_at);
  localStorage.setItem("digiy_fret_driver_phone", phone);

  location.href = "./index.html";
};
</script>
</body>
</html>
