<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY FRET ‚Äî Dashboard Chauffeur</title>
  <meta name="theme-color" content="#0ea5e9" />

  <!-- üîê TOKEN GUARD -->
  <script>
  function getSession(){
    try{
      const token = localStorage.getItem("digiy_fret_driver_token");
      const exp = localStorage.getItem("digiy_fret_driver_expires");
      if(!token || !exp) return null;
      return { token, exp: new Date(exp) };
    }catch(e){ return null; }
  }
  function isExpired(exp){ return Date.now() >= exp.getTime(); }
  function logout(reason){
    try{
      localStorage.removeItem("digiy_fret_driver_token");
      localStorage.removeItem("digiy_fret_driver_expires");
      localStorage.removeItem("digiy_fret_driver_phone");
    }catch(e){}
    if(reason) alert(reason);
    location.replace("./login.html");
  }
  (function(){
    const s = getSession();
    if(!s) return logout("Veuillez vous reconnecter");
    if(isExpired(s.exp)) return logout("Session expir√©e");
  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f7fbff;--card:#fff;--line:rgba(0,0,0,.08);
      --sky:#0ea5e9;--gold:#f59e0b;--ok:#16a34a;--bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,Arial;
      background:linear-gradient(180deg,#f7fbff,#fff7ed);
      padding:16px;
    }
    header{
      display:flex;justify-content:space-between;align-items:center;
      background:#fff;border:1px solid var(--line);
      border-radius:18px;padding:14px 16px;margin-bottom:16px;
    }
    h1{margin:0;font-size:18px}
    button{
      padding:10px 14px;border-radius:12px;
      border:0;font-weight:900;cursor:pointer;
    }
    .btn{background:#e0f2fe}
    .btn.danger{background:#fee2e2}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:#fff;border:1px solid var(--line);
      border-radius:18px;padding:14px;
    }
    .job{
      border:1px solid var(--line);
      border-radius:14px;padding:12px;margin-bottom:10px;
    }
    .job b{display:block}
    .chip{
      display:inline-block;margin-top:6px;margin-right:6px;
      padding:6px 10px;border-radius:999px;
      background:#f1f5f9;font-weight:900;font-size:12px;
    }
    .actions button{
      margin-top:8px;margin-right:6px;
      background:#e0f2fe;
    }
    .actions .ok{background:#dcfce7}
    .actions .bad{background:#fee2e2}
  </style>
</head>

<body>

<header>
  <h1>üöö DIGIY FRET ‚Äî Chauffeur</h1>
  <button class="btn danger" onclick="logout('D√©connexion')">D√©connexion</button>
</header>

<div class="grid">
  <!-- MISSIONS -->
  <div class="card">
    <h2>üì¶ Missions Fret</h2>
    <div id="jobs"></div>
  </div>

  <!-- PROFIL -->
  <div class="card">
    <h2>üßë‚Äç‚úàÔ∏è Mon statut</h2>
    <p><b>T√©l√©phone :</b> <span id="phone"></span></p>
    <p><b>√âtat :</b> <span id="state">DISPO</span></p>
    <button class="btn" onclick="toggleDispo()">Changer statut</button>
  </div>
</div>

<script>
/* SUPABASE */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* STATE */
const phone = localStorage.getItem("digiy_fret_driver_phone");
document.getElementById("phone").textContent = phone || "‚Äî";
let dispo = true;

/* DEMO DATA (remplac√© ensuite par RPC) */
const demoJobs = [
  {id:"FRET-001", from:"Dakar Plateau", to:"Pikine", price:4500, status:"pending"},
  {id:"FRET-002", from:"Saly", to:"Ngaparou", price:6500, status:"accepted"}
];

function renderJobs(){
  const box = document.getElementById("jobs");
  box.innerHTML = "";
  demoJobs.forEach(j=>{
    const el = document.createElement("div");
    el.className = "job";
    el.innerHTML = `
      <b>Mission ${j.id}</b>
      <div class="chip">üìç ${j.from} ‚Üí ${j.to}</div>
      <div class="chip">üí∞ ${j.price} F CFA</div>
      <div class="chip">üßæ ${j.status.toUpperCase()}</div>
      <div class="actions">
        ${j.status==="pending" ? `<button class="ok">Accepter</button>` : ``}
        ${j.status==="accepted" ? `<button class="ok">D√©marrer</button>` : ``}
        ${j.status!=="done" ? `<button class="bad">Refuser</button>` : ``}
      </div>
    `;
    box.appendChild(el);
  });
}

function toggleDispo(){
  dispo = !dispo;
  document.getElementById("state").textContent = dispo ? "DISPO" : "PAUSE";
}

renderJobs();
</script>

</body>
</html>


